name: Verify Generated Client

on:
  pull_request:

jobs:
  verify-client:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.15"
          enable-cache: true

      - name: Install admin frontend dependencies
        run: npm ci
        working-directory: frontend/admin

      - name: Install student frontend dependencies
        run: npm ci
        working-directory: frontend/student

      - name: Install backend dependencies
        run: uv sync
        working-directory: backend

      - name: Generate client
        run: uv run bash scripts/generate-client.sh
        env:
          VIRTUAL_ENV: backend/.venv
          SECRET_KEY: just-for-generating-client
          POSTGRES_PASSWORD: just-for-generating-client
          FIRST_SUPERUSER_PASSWORD: just-for-generating-client

      - name: Check for uncommitted changes (Admin App)
        run: |
          if ! git diff --quiet frontend/admin/src/client; then
            echo "::error::Generated client is out of date. Run 'bash scripts/generate-client.sh' locally and commit the changes."
            git diff --stat frontend/admin/src/client
            exit 1
          fi
          echo "✅ Generated client is up to date."

      - name: Check for uncommitted changes (Student App)
        run: |
          if ! git diff --quiet frontend/student/src/client; then
            echo "::error::Generated client is out of date. Run 'bash scripts/generate-client.sh' locally and commit the changes."
            git diff --stat frontend/student/src/client
            exit 1
          fi
          echo "✅ Generated client is up to date."

      # Similar steps should be added when the script generates other clients.
      # - name: Check for uncommitted changes (Other App)
      #   run: |
      #     if ! git diff --quiet frontend/other/src/client; then
      #       echo "::error::Generated client is out of date. Run 'bash scripts/generate-client.sh' locally and commit the changes."
      #       git diff --stat frontend/other/src/client
      #       exit 1
      #     fi
      #     echo "✅ Generated client is up to date."
